<!DOCTYPE html>
<html lang="ar" dir="rtl">

<head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>Ø¯ÙƒØ§Ù† ÙÙŠØ¬ÙŠÙ† - Ù„ÙˆØ­Ø© Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…</title>
    <meta name="description" content="Ù„ÙˆØ­Ø© ØªØ­ÙƒÙ… Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… - Ø¯ÙƒØ§Ù† ÙÙŠØ¬ÙŠÙ†" />
    <link href="https://fonts.googleapis.com/css2?family=Tajawal:wght@400;500;700;800&display=swap" rel="stylesheet">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/qrcodejs/1.0.0/qrcode.min.js"></script>
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" crossorigin="" />
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js" crossorigin defer></script>
    <link rel="stylesheet" href="../css/base.css">
    <link rel="stylesheet" href="../css/user.css">
    
    <!-- Database Integration -->
    <script type="module" src="js/user.js"></script>
</head>

<body>
    <!-- User Dashboard -->
    <div class="view active">
        <!-- Navigation -->
        <nav class="nav">
            <div class="wrap">
                <div class="brand">
                    <img src="../img/Logo.png" alt="Dukkan Vision">
                    <span class="brand-sub">Ù…Ø±Ø­Ø¨Ù‹Ø§ Ø¨Ùƒ Ù…Ø¬Ø¯Ø¯Ù‹Ø§ ÙÙŠ <span class="brand-name">Ø¯ÙƒØ§Ù† ÙÙŠØ¬ÙŠÙ†</span></span>
                </div>
                <div class="nav-links">
                    <a href="#dashboard" onclick="scrollToSection('dashboard')">Ù…Ù„Ø®Ù‘Øµ</a>
                    <a href="#sadeeq" onclick="scrollToSection('sadeeq')">Ù…Ø³Ø§Ø¹Ø¯Ùƒ ØµØ¯ÙŠÙ‚</a>
                    <a href="#invoices" onclick="scrollToSection('invoices')">ÙÙˆØ§ØªÙŠØ±Ùƒ</a>
                    <a href="#support" onclick="scrollToSection('support')">Ø§Ù„Ø¯Ø¹Ù…</a>
                </div>
                <div class="cta">
                    <div class="user-actions">
                        <div class="user-buttons">
                            <a class="btn btn-account" href="account.html">Ù…Ø¹Ù„ÙˆÙ…Ø§Øª Ø§Ù„Ø­Ø³Ø§Ø¨</a>
                            <button class="btn btn-outline" onclick="logoutUser()">ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø®Ø±ÙˆØ¬</button>
                        </div>
                    </div>

                    <!-- Small QR Code -->
                    <div class="qr-small">
                        <button class="btn btn-qr" onclick="window.location.href='qr.html'" title="Ø§Ø¶ØºØ· Ù„Ø¹Ø±Ø¶ QR Code">
                        <img src="../img/QR.png" alt="QR Code" style="width: 70px; height: 70px;">
                    </button>
                    </div>

                    <!-- Account Dropdown Menu -->
                    <div class="account-dropdown" id="accountDropdown">
                        <div class="dropdown-header">
                            <div class="user-avatar">
                                <div class="avatar-gradient"></div>
                            </div>
                            <div class="user-info">
                                <div class="brand-name">Ø¯ÙƒØ§Ù† ÙÙŠØ¬ÙŠÙ†</div>
                                <div class="user-name" id="dropdownName">ØªØ­Ù…ÙŠÙ„...</div>
                                <div class="user-email" id="dropdownEmail">ØªØ­Ù…ÙŠÙ„...</div>
                            </div>
                        </div>

                        <div class="dropdown-content">
                            <button class="dropdown-btn logout-btn" onclick="logoutUser()">
                            ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø®Ø±ÙˆØ¬
                        </button>

                            <div class="qr-section">
                                <div class="qr-code" id="dropdownQR">
                                    <!-- QR Code will be generated here -->
                                </div>
                                <div class="qr-label">QR Code</div>
                            </div>

                            <button class="dropdown-btn account-info-btn" onclick="showAccountInfo()">
                            Ù…Ø¹Ù„ÙˆÙ…Ø§Øª Ø§Ù„Ø­Ø³Ø§Ø¨
                        </button>
                        </div>
                    </div>


                </div>
            </div>
        </nav>

        <!-- Main Content -->
        <main class="main">
            <div class="wrap">
                <!-- Dashboard Content -->
                <div id="page-dashboard" class="page active">
                    <div class="dashboard-grid">
                        <!-- Single Column Layout -->
                        <div class="left-column">
                            <!-- Data Summary Cards -->
                            <div class="data-summary" id="dashboard">
                                <h3 class="dashboard-title">Ù…Ù„Ø®Ù‘Øµ Ø²ÙŠØ§Ø±Ø§ØªÙƒ ÙˆØ¥Ù†ÙØ§Ù‚Ùƒ</h3>
                                <div class="summary-cards">
                                    <div class="summary-card yellow">
                                        <div class="card-content">
                                            <div class="card-title">Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ù…ØµØ±ÙˆÙ</div>
                                            <div class="card-value" id="kSpend">0.00 Ø±.Ø³</div>
                                            <canvas id="sparkSpend" width="100" height="30"></canvas>
                                        </div>
                                    </div>
                                    <div class="summary-card green">
                                        <div class="card-content">
                                            <div class="card-title">Ø¹Ø¯Ø¯ Ø§Ù„Ø²ÙŠØ§Ø±Ø§Øª</div>
                                            <div class="card-value" id="kVisits">0</div>
                                            <canvas id="sparkVisits" width="100" height="30"></canvas>
                                        </div>
                                    </div>
                                    <div class="summary-card yellow">
                                        <div class="card-content">
                                            <div class="card-title">Ø£ÙƒØ«Ø± ÙØ±Ø¹ Ø²ÙŠØ§Ø±Ø©</div>
                                            <div class="card-value" id="kTop">ØºÙŠØ± Ù…Ø­Ø¯Ø¯</div>
                                            <canvas id="sparkTop" width="100" height="30"></canvas>
                                        </div>
                                    </div>
                                    <div class="summary-card green">
                                        <div class="card-content">
                                            <div class="card-title">Ù…ØªÙˆØ³Ø· Ø§Ù„ÙØ§ØªÙˆØ±Ø©</div>
                                            <div class="card-value" id="kAvg">0.00 Ø±.Ø³</div>
                                            <canvas id="sparkAvg" width="100" height="30"></canvas>
                                        </div>
                                    </div>
                                </div>

                            </div>

                            <!-- Assistant (Sadeeq) -->
                            <div class="assistant-section" id="sadeeq">
                                <div class="card">
                                    <h3>Ø§Ù„Ù…Ø³Ø§Ø¹Ø¯ Ø§Ù„Ø§ÙØªØ±Ø§Ø¶ÙŠ</h3>
                                    <div class="chat-messages" id="chatMessages">
                                        <div class="msg msg-bot">Ù…Ø±Ø­Ø¨Ø§Ù‹ØŒ Ø£Ù†Ø§ ØµØ¯ÙŠÙ‚ ğŸ‘‹ØŒ Ù…Ø³Ø§Ø¹Ø¯Ùƒ Ø§Ù„Ø°ÙƒÙŠ ÙÙŠ Ø¯ÙƒØ§Ù† ÙØ¬Ù†ØŒ ÙƒÙŠÙ Ø£Ù‚Ø¯Ø± Ø£Ø³Ø§Ø¹Ø¯Ùƒ Ø§Ù„ÙŠÙˆÙ…ØŸ</div>
                                    </div>
                                    <div class="chat-input">
                                        <div class="chat-input-container">
                                            <textarea placeholder="Ø§Ø³Ø£Ù„ Ø¹Ù† Ù…Ù†ØªØ¬ØŒ ÙØ§ØªÙˆØ±Ø©ØŒ ..." id="chatInput" rows="1"></textarea>
                                            <button class="send-btn" id="sendMessageBtn">Ø¥Ø±Ø³Ø§Ù„</button>
                                        </div>
                                        <div class="chat-controls">
                                            <button class="btn btn-sm btn-clear" id="clearChatBtn">Ù…Ø³Ø­ Ø§Ù„Ù…Ø­Ø§Ø¯Ø«Ø©</button>
                                        </div>
                                    </div>
                                </div>
                            </div>

                            <!-- Invoices Section -->
                            <div class="invoices-section" id="invoices">
                                <div class="card">
                                    <h3>Ø§Ù„ÙÙˆØ§ØªÙŠØ±</h3>
                                    <div class="invoices-list" id="invoicesList">
                                        <!-- Invoices will be loaded from database -->
                                    </div>
                                    <div class="invoices-link">
                                        <a href="invoices-management.html">- Ø¥Ø¯Ø§Ø±Ø© ÙÙˆØ§ØªÙŠØ±ÙŠ -</a>
                                    </div>
                                </div>
                            </div>

                            <!-- Support Section -->
                            <div class="contact-section" id="support">
                                <div class="card">
                                    <h3>Ø§Ù„Ø¯Ø¹Ù…</h3>
                                    <div class="support-info">
                                        <p>Ù‡Ù„ ØªØ­ØªØ§Ø¬ Ù…Ø³Ø§Ø¹Ø¯Ø©ØŸ ÙŠÙ…ÙƒÙ†Ùƒ Ø§Ù„ØªÙˆØ§ØµÙ„ Ù…Ø¹Ù†Ø§ Ø¹Ø¨Ø±:</p>
                                        <div class="support-links">
                                            <a href="support.html" class="btn btn-gradient">ØµÙØ­Ø© Ø§Ù„Ø¯Ø¹Ù…</a>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </main>

        <!-- Footer -->
        <footer class="footer">
            <div class="wrap">
                <div class="footer-content">
                    <div class="footer-copyright">
                        2025 - Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø­Ù‚ÙˆÙ‚ Ù…Ø­ÙÙˆØ¸Ø©.
                    </div>
                    <div class="footer-brand">
                        <img src="img/Logo.png" alt="Dukkan Vision">
                        <span>Ø¯ÙƒØ§Ù† ÙÙŠØ¬ÙŠÙ†</span>
                    </div>
                </div>
            </div>
        </footer>
    </div>

    <!-- Scripts -->
    <script>
        // Simple logout function
        function logoutUser() {
            console.log('Logout function called');
            
            // Clear user data from localStorage
            localStorage.removeItem('current_user');
            localStorage.removeItem('twq_cart');
            
            console.log('User data cleared, redirecting to login page...');
            
            // Redirect to login page
            window.location.href = 'login.html';
        }

        // Chat functionality - Direct implementation
        document.addEventListener('DOMContentLoaded', function() {
            const chatInput = document.getElementById('chatInput');
            const chatMessages = document.getElementById('chatMessages');
            const sendMessageBtn = document.getElementById('sendMessageBtn');
            const clearChatBtn = document.getElementById('clearChatBtn');

            function addMessage(text, type) {
                if (!chatMessages) return;
                const messageDiv = document.createElement('div');
                const messageId = Date.now();
                messageDiv.id = `msg-${messageId}`;
                messageDiv.className = `msg msg-${type}`;
                messageDiv.textContent = text;
                chatMessages.appendChild(messageDiv);
                chatMessages.scrollTop = chatMessages.scrollHeight;
                return messageId;
            }

            function removeMessage(messageId) {
                const messageDiv = document.getElementById(`msg-${messageId}`);
                if (messageDiv) {
                    messageDiv.remove();
                }
            }

            async function handleSend() {
                const query = (chatInput?.value || '').trim();
                if (!query) return;
                
                // Add user message
                addMessage(query, 'user');
                if (chatInput) chatInput.value = '';

                try {
                    // Show loading message
                    const loadingId = addMessage('Ø¬Ø§Ø±ÙŠ Ø§Ù„Ø¨Ø­Ø« Ø¹Ù† Ø¥Ø¬Ø§Ø¨Ø©...', 'bot');
                    
                    // Get current user data
                    const currentUserStr = localStorage.getItem('current_user');
                    const currentUser = currentUserStr ? JSON.parse(currentUserStr) : null;
                    
                    // Get user name from multiple possible sources
                    let userName = 'Ù…Ø³ØªØ®Ø¯Ù…';
                    if (currentUser) {
                        if (currentUser.name && currentUser.name.trim()) {
                            userName = currentUser.name.trim();
                        } else if (currentUser.full_name && currentUser.full_name.trim()) {
                            userName = currentUser.full_name.trim();
                        } else if (currentUser.first_name && currentUser.first_name.trim()) {
                            userName = currentUser.first_name.trim();
                        } else if (currentUser.email && currentUser.email.includes('@')) {
                            // Extract name from email if available
                            const emailName = currentUser.email.split('@')[0];
                            if (emailName && emailName.trim()) {
                                userName = emailName.trim();
                            }
                        }
                    }
                    
                    console.log('Sending request to RAG API:', {
                        question: query,
                        user_id: currentUser?.id || null,
                        user_name: userName,
                        currentUser: currentUser
                    });
                    
                    // Call RAG API
                    const response = await fetch('http://localhost:8001/ask', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                            'Accept': 'application/json',
                        },
                        mode: 'cors',
                        body: JSON.stringify({
                            question: query,
                            user_id: currentUser?.id || null,
                            user_name: userName
                        })
                    });
                    
                    // Remove loading message
                    removeMessage(loadingId);

                    if (response.ok) {
                        const result = await response.json();
                        console.log('RAG API response:', result);
                        addMessage(result.answer, 'bot');
                    } else {
                        const errorText = await response.text();
                        console.error('RAG API error:', response.status, response.statusText);
                        console.error('Error details:', errorText);
                        addMessage(`Ø¹Ø°Ø±Ø§Ù‹ØŒ Ø­Ø¯Ø« Ø®Ø·Ø£ ÙÙŠ Ø§Ù„Ø§ØªØµØ§Ù„ (${response.status}). ØªØ£ÙƒØ¯ Ù…Ù† Ø£Ù† Ø§Ù„Ø®Ø§Ø¯Ù… ÙŠØ¹Ù…Ù„ Ø¹Ù„Ù‰ Ø§Ù„Ù…Ù†ÙØ° 8001.`, 'bot');
                    }
                } catch (error) {
                    console.error('Error calling RAG API:', error);
                    addMessage('Ø¹Ø°Ø±Ø§Ù‹ØŒ Ø­Ø¯Ø« Ø®Ø·Ø£ ÙÙŠ Ø§Ù„Ø§ØªØµØ§Ù„. ØªØ£ÙƒØ¯ Ù…Ù† Ø£Ù† Ø§Ù„Ø®Ø§Ø¯Ù… ÙŠØ¹Ù…Ù„ Ø¹Ù„Ù‰ Ø§Ù„Ù…Ù†ÙØ° 8001.', 'bot');
                }
            }

            function handleClear() {
                if (chatMessages) {
                    chatMessages.innerHTML = '<div class="msg msg-bot">Ù…Ø±Ø­Ø¨Ø§Ù‹ØŒ Ø£Ù†Ø§ ØµØ¯ÙŠÙ‚ ğŸ‘‹ØŒ Ù…Ø³Ø§Ø¹Ø¯Ùƒ Ø§Ù„Ø°ÙƒÙŠ ÙÙŠ Ø¯ÙƒØ§Ù† ÙØ¬Ù†ØŒ ÙƒÙŠÙ Ø£Ù‚Ø¯Ø± Ø£Ø³Ø§Ø¹Ø¯Ùƒ Ø§Ù„ÙŠÙˆÙ…ØŸ</div>';
                }
            }

            // Add event listeners
            if (sendMessageBtn) sendMessageBtn.addEventListener('click', handleSend);
            if (clearChatBtn) clearChatBtn.addEventListener('click', handleClear);
            
            if (chatInput) {
                // Auto-resize height to fit content
                const autoResize = () => {
                    if (chatInput) {
                        chatInput.style.height = 'auto';
                        chatInput.style.height = Math.min(chatInput.scrollHeight, 120) + 'px';
                    }
                };
                ['input','change'].forEach(evt => chatInput.addEventListener(evt, autoResize));
                autoResize();

                // Allow Enter key to send message
                chatInput.addEventListener('keypress', (e) => {
                    if (e.key === 'Enter' && !e.shiftKey) {
                        e.preventDefault();
                        handleSend();
                        autoResize();
                    }
                });
            }

            // Test connection and user data on page load
            async function testConnection() {
                try {
                    console.log('Testing RAG API connection...');
                    const response = await fetch('http://localhost:8001/', {
                        method: 'GET',
                        headers: {
                            'Accept': 'application/json',
                        },
                        mode: 'cors'
                    });
                    
                    if (response.ok) {
                        const data = await response.json();
                        console.log('âœ… RAG API is running:', data);
                        
                        // Test user data
                        const currentUserStr = localStorage.getItem('current_user');
                        if (currentUserStr) {
                            const currentUser = JSON.parse(currentUserStr);
                            console.log('ğŸ‘¤ Current user data:', currentUser);
                            
                            // Get user name from multiple possible sources
                            let userName = 'Ù…Ø³ØªØ®Ø¯Ù…';
                            if (currentUser) {
                                if (currentUser.name && currentUser.name.trim()) {
                                    userName = currentUser.name.trim();
                                } else if (currentUser.full_name && currentUser.full_name.trim()) {
                                    userName = currentUser.full_name.trim();
                                } else if (currentUser.first_name && currentUser.first_name.trim()) {
                                    userName = currentUser.first_name.trim();
                                } else if (currentUser.email && currentUser.email.includes('@')) {
                                    const emailName = currentUser.email.split('@')[0];
                                    if (emailName && emailName.trim()) {
                                        userName = emailName.trim();
                                    }
                                }
                            }
                            console.log('ğŸ‘¤ User name to be used:', userName);
                        } else {
                            console.log('âš ï¸ No user data found in localStorage');
                        }
                    } else {
                        console.error('âŒ RAG API is not responding properly');
                        addMessage('âš ï¸ ØªØ­Ø°ÙŠØ±: Ø®Ø§Ø¯Ù… Ø§Ù„Ù…Ø³Ø§Ø¹Ø¯ ØºÙŠØ± Ù…ØªØµÙ„. ÙŠØ±Ø¬Ù‰ ØªØ´ØºÙŠÙ„ Ø§Ù„Ø®Ø§Ø¯Ù… Ø£ÙˆÙ„Ø§Ù‹.', 'bot');
                    }
                } catch (error) {
                    console.error('âŒ Cannot connect to RAG API:', error);
                    addMessage('âš ï¸ ØªØ­Ø°ÙŠØ±: Ø®Ø§Ø¯Ù… Ø§Ù„Ù…Ø³Ø§Ø¹Ø¯ ØºÙŠØ± Ù…ØªØµÙ„. ÙŠØ±Ø¬Ù‰ ØªØ´ØºÙŠÙ„ Ø§Ù„Ø®Ø§Ø¯Ù… Ø£ÙˆÙ„Ø§Ù‹.', 'bot');
                }
            }

            // Test connection when page loads
            testConnection();
        });
    </script>
    <script src="../js/logout.js"></script>
</body>

</html>