<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>Ø§Ø®ØªØ¨Ø§Ø± ØµÙØ­Ø© Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… - Ø¯ÙƒØ§Ù† ÙÙŠØ¬ÙŠÙ†</title>
    <link href="https://fonts.googleapis.com/css2?family=Tajawal:wght@400;500;700;800&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="../css/base.css">
    <link rel="stylesheet" href="../css/user.css">
    <style>
        .test-container {
            max-width: 800px;
            margin: 50px auto;
            padding: 20px;
            background: white;
            border-radius: 16px;
            box-shadow: 0 4px 20px rgba(0,0,0,0.1);
        }
        .test-section {
            margin-bottom: 30px;
            padding: 20px;
            border: 1px solid #e5e7eb;
            border-radius: 8px;
        }
        .test-title {
            font-size: 18px;
            font-weight: 700;
            color: #111827;
            margin-bottom: 15px;
        }
        .test-button {
            background: linear-gradient(135deg, #8b5cf6 0%, #a855f7 100%);
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 8px;
            cursor: pointer;
            margin: 5px;
            font-weight: 600;
        }
        .test-button:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(139, 92, 246, 0.3);
        }
        .test-result {
            margin-top: 10px;
            padding: 10px;
            background: #f9fafb;
            border-radius: 6px;
            font-family: monospace;
            font-size: 14px;
        }
        .success { color: #059669; }
        .error { color: #dc2626; }
        .info { color: #2563eb; }
    </style>
</head>
<body>
    <div class="test-container">
        <h1 style="text-align: center; color: #111827; margin-bottom: 30px;">
            ğŸ§ª Ø§Ø®ØªØ¨Ø§Ø± ØµÙØ­Ø© Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… - Ø¯ÙƒØ§Ù† ÙÙŠØ¬ÙŠÙ†
        </h1>

        <!-- Ø§Ø®ØªØ¨Ø§Ø± Ù‚Ø§Ø¹Ø¯Ø© Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª -->
        <div class="test-section">
            <div class="test-title">ğŸ—„ï¸ Ø§Ø®ØªØ¨Ø§Ø± Ù‚Ø§Ø¹Ø¯Ø© Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª</div>
            <button class="test-button" onclick="testDatabaseConnection()">Ø§Ø®ØªØ¨Ø§Ø± Ø§Ù„Ø§ØªØµØ§Ù„</button>
            <button class="test-button" onclick="testUserData()">Ø§Ø®ØªØ¨Ø§Ø± Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…</button>
            <button class="test-button" onclick="testInvoices()">Ø§Ø®ØªØ¨Ø§Ø± Ø§Ù„ÙÙˆØ§ØªÙŠØ±</button>
            <div id="db-result" class="test-result"></div>
        </div>

        <!-- Ø§Ø®ØªØ¨Ø§Ø± Ø§Ù„Ù…Ø³Ø§Ø¹Ø¯ Ø§Ù„Ø°ÙƒÙŠ -->
        <div class="test-section">
            <div class="test-title">ğŸ¤– Ø§Ø®ØªØ¨Ø§Ø± Ø§Ù„Ù…Ø³Ø§Ø¹Ø¯ Ø§Ù„Ø°ÙƒÙŠ</div>
            <button class="test-button" onclick="testRAGConnection()">Ø§Ø®ØªØ¨Ø§Ø± RAG API</button>
            <button class="test-button" onclick="testChat()">Ø§Ø®ØªØ¨Ø§Ø± Ø§Ù„Ù…Ø­Ø§Ø¯Ø«Ø©</button>
            <div id="rag-result" class="test-result"></div>
        </div>

        <!-- Ø§Ø®ØªØ¨Ø§Ø± Ø§Ù„ÙˆØ§Ø¬Ù‡Ø© -->
        <div class="test-section">
            <div class="test-title">ğŸ¨ Ø§Ø®ØªØ¨Ø§Ø± Ø§Ù„ÙˆØ§Ø¬Ù‡Ø©</div>
            <button class="test-button" onclick="testNotifications()">Ø§Ø®ØªØ¨Ø§Ø± Ø§Ù„Ø¥Ø´Ø¹Ø§Ø±Ø§Øª</button>
            <button class="test-button" onclick="testAnimations()">Ø§Ø®ØªØ¨Ø§Ø± Ø§Ù„Ø§Ù†ÙŠÙ…ÙŠØ´Ù†</button>
            <button class="test-button" onclick="testResponsive()">Ø§Ø®ØªØ¨Ø§Ø± Ø§Ù„ØªØ¬Ø§ÙˆØ¨</button>
            <div id="ui-result" class="test-result"></div>
        </div>

        <!-- Ø§Ø®ØªØ¨Ø§Ø± Ø§Ù„Ø£Ù…Ø§Ù† -->
        <div class="test-section">
            <div class="test-title">ğŸ”’ Ø§Ø®ØªØ¨Ø§Ø± Ø§Ù„Ø£Ù…Ø§Ù†</div>
            <button class="test-button" onclick="testAuthentication()">Ø§Ø®ØªØ¨Ø§Ø± Ø§Ù„Ù…ØµØ§Ø¯Ù‚Ø©</button>
            <button class="test-button" onclick="testLogout()">Ø§Ø®ØªØ¨Ø§Ø± ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø®Ø±ÙˆØ¬</button>
            <div id="security-result" class="test-result"></div>
        </div>

        <!-- Ø§Ù„Ù†ØªØ§Ø¦Ø¬ Ø§Ù„Ø¥Ø¬Ù…Ø§Ù„ÙŠØ© -->
        <div class="test-section">
            <div class="test-title">ğŸ“Š Ø§Ù„Ù†ØªØ§Ø¦Ø¬ Ø§Ù„Ø¥Ø¬Ù…Ø§Ù„ÙŠØ©</div>
            <button class="test-button" onclick="runAllTests()">ØªØ´ØºÙŠÙ„ Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø§Ø®ØªØ¨Ø§Ø±Ø§Øª</button>
            <div id="overall-result" class="test-result"></div>
        </div>
    </div>

    <script type="module">
        import { db } from '../js/database.js';

        // Ø§Ø®ØªØ¨Ø§Ø± Ù‚Ø§Ø¹Ø¯Ø© Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª
        window.testDatabaseConnection = async function() {
            const result = document.getElementById('db-result');
            result.innerHTML = '<span class="info">Ø¬Ø§Ø±ÙŠ Ø§Ø®ØªØ¨Ø§Ø± Ø§Ù„Ø§ØªØµØ§Ù„...</span>';
            
            try {
                const { data, error } = await db.supabase.from('users').select('count').limit(1);
                if (error) throw error;
                result.innerHTML = '<span class="success">âœ… Ø§Ù„Ø§ØªØµØ§Ù„ Ø¨Ù‚Ø§Ø¹Ø¯Ø© Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ù†Ø§Ø¬Ø­</span>';
            } catch (error) {
                result.innerHTML = `<span class="error">âŒ ÙØ´Ù„ Ø§Ù„Ø§ØªØµØ§Ù„: ${error.message}</span>`;
            }
        };

        // Ø§Ø®ØªØ¨Ø§Ø± Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…
        window.testUserData = async function() {
            const result = document.getElementById('db-result');
            result.innerHTML = '<span class="info">Ø¬Ø§Ø±ÙŠ Ø§Ø®ØªØ¨Ø§Ø± Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…...</span>';
            
            try {
                const currentUser = JSON.parse(localStorage.getItem('current_user') || 'null');
                if (!currentUser) {
                    result.innerHTML = '<span class="error">âŒ Ù„Ø§ ÙŠÙˆØ¬Ø¯ Ù…Ø³ØªØ®Ø¯Ù… Ù…Ø³Ø¬Ù„ Ø¯Ø®ÙˆÙ„</span>';
                    return;
                }
                
                const { data, error } = await db.supabase
                    .from('users')
                    .select('*')
                    .eq('id', currentUser.id)
                    .single();
                
                if (error) throw error;
                result.innerHTML = `<span class="success">âœ… Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… Ù…Ø­Ù…Ù„Ø©: ${data.first_name} ${data.last_name}</span>`;
            } catch (error) {
                result.innerHTML = `<span class="error">âŒ ÙØ´Ù„ ÙÙŠ ØªØ­Ù…ÙŠÙ„ Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…: ${error.message}</span>`;
            }
        };

        // Ø§Ø®ØªØ¨Ø§Ø± Ø§Ù„ÙÙˆØ§ØªÙŠØ±
        window.testInvoices = async function() {
            const result = document.getElementById('db-result');
            result.innerHTML = '<span class="info">Ø¬Ø§Ø±ÙŠ Ø§Ø®ØªØ¨Ø§Ø± Ø§Ù„ÙÙˆØ§ØªÙŠØ±...</span>';
            
            try {
                const currentUser = JSON.parse(localStorage.getItem('current_user') || 'null');
                if (!currentUser) {
                    result.innerHTML = '<span class="error">âŒ Ù„Ø§ ÙŠÙˆØ¬Ø¯ Ù…Ø³ØªØ®Ø¯Ù… Ù…Ø³Ø¬Ù„ Ø¯Ø®ÙˆÙ„</span>';
                    return;
                }
                
                const { data, error } = await db.supabase
                    .from('invoices')
                    .select('*')
                    .eq('user_id', currentUser.id)
                    .limit(5);
                
                if (error) throw error;
                result.innerHTML = `<span class="success">âœ… ØªÙ… ØªØ­Ù…ÙŠÙ„ ${data.length} ÙØ§ØªÙˆØ±Ø©</span>`;
            } catch (error) {
                result.innerHTML = `<span class="error">âŒ ÙØ´Ù„ ÙÙŠ ØªØ­Ù…ÙŠÙ„ Ø§Ù„ÙÙˆØ§ØªÙŠØ±: ${error.message}</span>`;
            }
        };

        // Ø§Ø®ØªØ¨Ø§Ø± RAG API
        window.testRAGConnection = async function() {
            const result = document.getElementById('rag-result');
            result.innerHTML = '<span class="info">Ø¬Ø§Ø±ÙŠ Ø§Ø®ØªØ¨Ø§Ø± RAG API...</span>';
            
            try {
                const response = await fetch('http://localhost:8001/', {
                    method: 'GET',
                    headers: { 'Accept': 'application/json' },
                    mode: 'cors'
                });
                
                if (response.ok) {
                    const data = await response.json();
                    result.innerHTML = '<span class="success">âœ… RAG API ÙŠØ¹Ù…Ù„ Ø¨Ø´ÙƒÙ„ ØµØ­ÙŠØ­</span>';
                } else {
                    throw new Error(`HTTP ${response.status}`);
                }
            } catch (error) {
                result.innerHTML = `<span class="error">âŒ RAG API ØºÙŠØ± Ù…ØªØ§Ø­: ${error.message}</span>`;
            }
        };

        // Ø§Ø®ØªØ¨Ø§Ø± Ø§Ù„Ù…Ø­Ø§Ø¯Ø«Ø©
        window.testChat = async function() {
            const result = document.getElementById('rag-result');
            result.innerHTML = '<span class="info">Ø¬Ø§Ø±ÙŠ Ø§Ø®ØªØ¨Ø§Ø± Ø§Ù„Ù…Ø­Ø§Ø¯Ø«Ø©...</span>';
            
            try {
                const response = await fetch('http://localhost:8001/ask', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Accept': 'application/json',
                    },
                    mode: 'cors',
                    body: JSON.stringify({
                        question: 'Ù…Ø±Ø­Ø¨Ø§',
                        user_id: 'test-user',
                        user_name: 'Ù…Ø³ØªØ®Ø¯Ù… Ø§Ø®ØªØ¨Ø§Ø±'
                    })
                });
                
                if (response.ok) {
                    const data = await response.json();
                    result.innerHTML = '<span class="success">âœ… Ø§Ù„Ù…Ø­Ø§Ø¯Ø«Ø© ØªØ¹Ù…Ù„ Ø¨Ø´ÙƒÙ„ ØµØ­ÙŠØ­</span>';
                } else {
                    throw new Error(`HTTP ${response.status}`);
                }
            } catch (error) {
                result.innerHTML = `<span class="error">âŒ ÙØ´Ù„ ÙÙŠ Ø§Ù„Ù…Ø­Ø§Ø¯Ø«Ø©: ${error.message}</span>`;
            }
        };

        // Ø§Ø®ØªØ¨Ø§Ø± Ø§Ù„Ø¥Ø´Ø¹Ø§Ø±Ø§Øª
        window.testNotifications = function() {
            const result = document.getElementById('ui-result');
            result.innerHTML = '<span class="info">Ø¬Ø§Ø±ÙŠ Ø§Ø®ØªØ¨Ø§Ø± Ø§Ù„Ø¥Ø´Ø¹Ø§Ø±Ø§Øª...</span>';
            
            // Ø¥Ù†Ø´Ø§Ø¡ Ø¥Ø´Ø¹Ø§Ø± Ù†Ø¬Ø§Ø­
            const notification = document.createElement('div');
            notification.textContent = 'Ø§Ø®ØªØ¨Ø§Ø± Ø§Ù„Ø¥Ø´Ø¹Ø§Ø±Ø§Øª';
            notification.style.cssText = `
                position: fixed;
                top: 20px;
                right: 20px;
                background: #10b981;
                color: white;
                padding: 12px 20px;
                border-radius: 8px;
                z-index: 10000;
                animation: slideInRight 0.3s ease-out;
                font-weight: 600;
            `;
            
            document.body.appendChild(notification);
            
            setTimeout(() => {
                notification.remove();
                result.innerHTML = '<span class="success">âœ… Ø§Ù„Ø¥Ø´Ø¹Ø§Ø±Ø§Øª ØªØ¹Ù…Ù„ Ø¨Ø´ÙƒÙ„ ØµØ­ÙŠØ­</span>';
            }, 2000);
        };

        // Ø§Ø®ØªØ¨Ø§Ø± Ø§Ù„Ø§Ù†ÙŠÙ…ÙŠØ´Ù†
        window.testAnimations = function() {
            const result = document.getElementById('ui-result');
            result.innerHTML = '<span class="info">Ø¬Ø§Ø±ÙŠ Ø§Ø®ØªØ¨Ø§Ø± Ø§Ù„Ø§Ù†ÙŠÙ…ÙŠØ´Ù†...</span>';
            
            const testElement = document.createElement('div');
            testElement.textContent = 'Ø¹Ù†ØµØ± Ø§Ø®ØªØ¨Ø§Ø±';
            testElement.style.cssText = `
                padding: 20px;
                background: #8b5cf6;
                color: white;
                border-radius: 8px;
                margin: 10px 0;
                animation: fadeInUp 0.5s ease-out;
            `;
            
            document.querySelector('.test-container').appendChild(testElement);
            
            setTimeout(() => {
                testElement.remove();
                result.innerHTML = '<span class="success">âœ… Ø§Ù„Ø§Ù†ÙŠÙ…ÙŠØ´Ù† ÙŠØ¹Ù…Ù„ Ø¨Ø´ÙƒÙ„ ØµØ­ÙŠØ­</span>';
            }, 1000);
        };

        // Ø§Ø®ØªØ¨Ø§Ø± Ø§Ù„ØªØ¬Ø§ÙˆØ¨
        window.testResponsive = function() {
            const result = document.getElementById('ui-result');
            const width = window.innerWidth;
            
            if (width < 768) {
                result.innerHTML = '<span class="success">âœ… Ø§Ù„ØªØ¬Ø§ÙˆØ¨ Ù„Ù„Ù…ÙˆØ¨Ø§ÙŠÙ„ ÙŠØ¹Ù…Ù„</span>';
            } else if (width < 1024) {
                result.innerHTML = '<span class="success">âœ… Ø§Ù„ØªØ¬Ø§ÙˆØ¨ Ù„Ù„ØªØ§Ø¨Ù„Øª ÙŠØ¹Ù…Ù„</span>';
            } else {
                result.innerHTML = '<span class="success">âœ… Ø§Ù„ØªØ¬Ø§ÙˆØ¨ Ù„Ù„Ø¯ÙŠØ³ÙƒØªÙˆØ¨ ÙŠØ¹Ù…Ù„</span>';
            }
        };

        // Ø§Ø®ØªØ¨Ø§Ø± Ø§Ù„Ù…ØµØ§Ø¯Ù‚Ø©
        window.testAuthentication = function() {
            const result = document.getElementById('security-result');
            const currentUser = localStorage.getItem('current_user');
            
            if (currentUser) {
                result.innerHTML = '<span class="success">âœ… Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… Ù…Ø³Ø¬Ù„ Ø¯Ø®ÙˆÙ„</span>';
            } else {
                result.innerHTML = '<span class="error">âŒ Ù„Ø§ ÙŠÙˆØ¬Ø¯ Ù…Ø³ØªØ®Ø¯Ù… Ù…Ø³Ø¬Ù„ Ø¯Ø®ÙˆÙ„</span>';
            }
        };

        // Ø§Ø®ØªØ¨Ø§Ø± ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø®Ø±ÙˆØ¬
        window.testLogout = function() {
            const result = document.getElementById('security-result');
            result.innerHTML = '<span class="info">Ø¬Ø§Ø±ÙŠ Ø§Ø®ØªØ¨Ø§Ø± ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø®Ø±ÙˆØ¬...</span>';
            
            // Ù…Ø­Ø§ÙƒØ§Ø© ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø®Ø±ÙˆØ¬
            localStorage.removeItem('current_user');
            
            setTimeout(() => {
                const currentUser = localStorage.getItem('current_user');
                if (!currentUser) {
                    result.innerHTML = '<span class="success">âœ… ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø®Ø±ÙˆØ¬ ÙŠØ¹Ù…Ù„ Ø¨Ø´ÙƒÙ„ ØµØ­ÙŠØ­</span>';
                } else {
                    result.innerHTML = '<span class="error">âŒ ÙØ´Ù„ ÙÙŠ ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø®Ø±ÙˆØ¬</span>';
                }
            }, 500);
        };

        // ØªØ´ØºÙŠÙ„ Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø§Ø®ØªØ¨Ø§Ø±Ø§Øª
        window.runAllTests = async function() {
            const result = document.getElementById('overall-result');
            result.innerHTML = '<span class="info">Ø¬Ø§Ø±ÙŠ ØªØ´ØºÙŠÙ„ Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø§Ø®ØªØ¨Ø§Ø±Ø§Øª...</span>';
            
            let passed = 0;
            let total = 0;
            
            // Ø§Ø®ØªØ¨Ø§Ø± Ù‚Ø§Ø¹Ø¯Ø© Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª
            total++;
            try {
                const { data, error } = await db.supabase.from('users').select('count').limit(1);
                if (!error) passed++;
            } catch (e) {}
            
            // Ø§Ø®ØªØ¨Ø§Ø± RAG API
            total++;
            try {
                const response = await fetch('http://localhost:8001/', {
                    method: 'GET',
                    headers: { 'Accept': 'application/json' },
                    mode: 'cors'
                });
                if (response.ok) passed++;
            } catch (e) {}
            
            // Ø§Ø®ØªØ¨Ø§Ø± Ø§Ù„Ù…ØµØ§Ø¯Ù‚Ø©
            total++;
            if (localStorage.getItem('current_user')) passed++;
            
            const percentage = Math.round((passed / total) * 100);
            result.innerHTML = `<span class="${percentage >= 80 ? 'success' : 'error'}">
                ğŸ“Š Ø§Ù„Ù†ØªØ§Ø¦Ø¬: ${passed}/${total} (${percentage}%)
            </span>`;
        };

        // Ø¥Ø¶Ø§ÙØ© CSS Ù„Ù„Ø§Ù†ÙŠÙ…ÙŠØ´Ù†
        const style = document.createElement('style');
        style.textContent = `
            @keyframes slideInRight {
                from { opacity: 0; transform: translateX(30px); }
                to { opacity: 1; transform: translateX(0); }
            }
            @keyframes fadeInUp {
                from { opacity: 0; transform: translateY(20px); }
                to { opacity: 1; transform: translateY(0); }
            }
        `;
        document.head.appendChild(style);
    </script>
</body>
</html>
